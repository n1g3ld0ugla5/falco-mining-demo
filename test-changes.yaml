customRules:
  rules-mining.yaml: |-
    - rule: Miner Binary Detected
      desc: "Malicious script or binary detected in pod or host. The rule was triggered by the execve syscall"
      condition: >
        spawned_process and (
          in_malicious_binaries or (
            proc.name in (shell_binaries) and
            scripts_in_or and
            not proc.args startswith "-c"
          )
        )
      output: >
        Malicious binary or script executed in the pod or host.
        proc.cmdline=%proc.cmdline evt.type=%evt.type evt.res=%evt.res
        proc.pid=%proc.pid proc.cwd=%proc.cwd proc.ppid=%proc.ppid
        proc.pcmdline=%proc.pcmdline proc.sid=%proc.sid proc.exepath=%proc.exepath
        user.uid=%user.uid user.loginuid=%user.loginuid
        user.loginname=%user.loginname user.name=%user.name group.gid=%group.gid
        group.name=%group.name container.id=%container.id
        container.name=%container.name %evt.args
      priority: WARNING
      tags:
        - cryptomining
        - mitre_persistence
      source: syscall

    - macro: in_malicious_binaries
      condition: (proc.name in (malicious_binaries))
    - list: malicious_binaries
      items:
        - "xmrig"
        - ".x1mr"
        - "nanominer"
        - "pwnrig"
        - "astrominer"
        - "eazyminer"
        - "pool-miner-linux64"
    - macro: scripts_in_or
      condition: (
        proc.args endswith "/wb.sh" or
        proc.args endswith "/ldr.sh" or
        proc.args endswith "aktualisieren.sh" or
        proc.args endswith "creds.sh" or
        proc.args endswith "cronb.sh" or
        proc.args endswith "abah1.sh" or
        proc.args endswith "/huh.sh" or
        proc.args endswith "ohshit.sh" or
        proc.args endswith "/mxr.sh" )

    - rule: Command executed without specifying a cryptocurrency flag
      desc: Detects when a command is executed wit the -coin eth or -coin monero flag
      condition: >
        spawned_process
        and proc.cmdline endswith "-coin eth"
        or proc.cmdline endswith "-coin monero"
      output: >
        Command executed without specifying a cryptocurrency flag (user=%user.name container_id=%container.id command=%proc.cmdline)
      priority: WARNING
      tags: [container, cryptocurrency, mitre_execution]

    - rule: Destroy Kubernetes Resources
      desc: Detects kubectl delete cmd is executed
      condition: >
        spawned_process
        and proc_args_with_kubectl_delete
      output: >
        Kubernetes resource was destroyed (user=%user.name container_id=%container.id command=%proc.cmdline)
      priority: NOTICE
      tags: [kubernetes, container, mitre_data_destruction]
      
    - macro: proc_args_with_kubectl_delete
      condition: (
        proc.args contains "kubectl" and
        proc.args contains "apply" and
        proc.args contains "-f" )
    
    - rule: Outbound Connection to C2 Servers
      desc: Detect outbound connection to command & control servers thanks to a list of IP addresses & a list of FQDN.
      condition: >
        outbound and 
        ((fd.sip in (mining_ip_list)) or
         (fd.sip.name in (mining_fqdn_list)))
      output: Outbound connection to mining server (c2_domain=%fd.sip.name c2_addr=%fd.sip command=%proc.cmdline connection=%fd.name user=%user.name user_loginuid=%user.loginuid container_id=%container.id image=%container.image.repository)
      priority: WARNING
      tags: [host, container, network, mitre_command_and_control, TA0011]
      
    - list: mining_ip_list
      items: []

    - list: mining_fqdn_list
      items: [
          "xmr-us-east1.nanopool.org:14433" ]
